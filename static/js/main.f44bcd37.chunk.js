(this["webpackJsonpfb2-reader-react"]=this["webpackJsonpfb2-reader-react"]||[]).push([[0],{107:function(e,t,n){},110:function(e,t,n){"use strict";n.r(t);var a,r=n(1),o=n.n(r),i=n(4),c=n.n(i),s=(n(63),n(17)),l=n(56),u=n(19),d=n(20),m=n(29),h=n(28),p=(n(64),n(6)),f=[{key:"books",primaryText:"Books",leftIcon:o.a.createElement(p.h,null,"book"),active:!0},{key:"read",primaryText:"Read",leftIcon:o.a.createElement(p.h,null,"assignment")},{key:"drafts",primaryText:"Drafts",leftIcon:o.a.createElement(p.h,null,"drafts")},{key:"trash",primaryText:"Trash",leftIcon:o.a.createElement(p.h,null,"delete")}],b=n(8),v=n.n(b),k=n(12),y=n(41),x=n(57),g=Object(x.a)("fb2-reader",1,{upgrade:function(e){e.createObjectStore("books",{keyPath:"hashHex",autoIncrement:!0}).createIndex("author","author"),e.createObjectStore("sections",{keyPath:"id",autoIncrement:!0}).createIndex("parent","parent"),e.createObjectStore("elements",{keyPath:["sectionId","ordinal"]}).createIndex("sectionId","sectionId")}});function E(e){return a.count("books",e.hashHex)}function w(e){return a.add("sections",e)}function S(e){return a.add("elements",e)}function O(){return a?a.getAll("books"):g.then((function(){return a.getAll("books")}))}function j(e){return a?a.get("books",e):g.then((function(){return a.get("books",e)}))}g.then((function(e){return a=e}));var I=n(38);var T=function(){function e(t){Object(u.a)(this,e),this.xml=t,this.ordinal=0}return Object(d.a)(e,[{key:"parseSection",value:function(){var e=Object(k.a)(v.a.mark((function e(t,n){var a,r,o,i,c,s,l,u,d;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=t.querySelector("title"),i=t.querySelector("image"),c=t.querySelectorAll(":scope > *"),e.next=5,w({parent:n,ordinal:this.ordinal++,title:null!==(a=null===o||void 0===o?void 0:o.textContent)&&void 0!==a?a:null,image:null!==(r=null===i||void 0===i?void 0:i.href)&&void 0!==r?r:null});case 5:s=e.sent,l=Object(I.a)(c),e.prev=7,l.s();case 9:if((u=l.n()).done){e.next=20;break}if("section"!==(d=u.value).tagName){e.next=16;break}return e.next=14,this.parseSection(d,s);case 14:e.next=18;break;case 16:return e.next=18,S({tag:d.tagName,content:d.innerHTML,sectionId:s,ordinal:this.ordinal++});case 18:e.next=9;break;case 20:e.next=25;break;case 22:e.prev=22,e.t0=e.catch(7),l.e(e.t0);case 25:return e.prev=25,l.f(),e.finish(25);case 28:case"end":return e.stop()}}),e,this,[[7,22,25,28]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"parseBody",value:function(){var e=Object(k.a)(v.a.mark((function e(){var t,n,r,o,i,c,s,l,u,d,m;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,h=this.book,a.add("books",h);case 2:return r=e.sent,o=this.body,i=o.querySelector("title"),c=o.querySelector("image"),s=o.querySelectorAll(":scope > section"),e.next=9,w({title:null!==(t=null===i||void 0===i?void 0:i.textContent)&&void 0!==t?t:null,image:null!==(n=null===c||void 0===c?void 0:c.href)&&void 0!==n?n:null,ordinal:this.ordinal++,parent:r});case 9:l=e.sent,u=Object(I.a)(s),e.prev=11,u.s();case 13:if((d=u.n()).done){e.next=19;break}return m=d.value,e.next=17,this.parseSection(m,l);case 17:e.next=13;break;case 19:e.next=24;break;case 21:e.prev=21,e.t0=e.catch(11),u.e(e.t0);case 24:return e.prev=24,u.f(),e.finish(24);case 27:case"end":return e.stop()}var h}),e,this,[[11,21,24,27]])})));return function(){return e.apply(this,arguments)}}()},{key:"parseDescription",value:function(){var e=Object(k.a)(v.a.mark((function e(){var t,n,a,r,o,i,c,s,l,u,d,m,h,p,f;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,window.crypto.subtle.digest("SHA-512",new TextEncoder("utf-8").encode(this.xml));case 2:return t=e.sent,b=t,n=Array.prototype.map.call(new Uint8Array(b),(function(e){return("00"+e.toString(16)).slice(-2)})).join(""),a=new DOMParser,r=a.parseFromString(this.xml,"application/xml"),o=r.querySelector("description"),i=o.querySelector("author first-name").textContent+" "+o.querySelector("author last-name").textContent,c=o.querySelector("book-title"),s=(s=o.querySelector("annotation"))&&s.textContent,(u=o.querySelector("coverpage image"))&&(d=u.getAttribute("l:href"))&&/^#/.test(d)&&(m=d.slice(1),(h=r.querySelector('binary[id="'.concat(m,'"]')))&&(p=h.getAttribute("content-type"),l="data:".concat(p,";base64,").concat(h.innerHTML))),f={hashHex:n,author:i,title:c.textContent,annotation:s,image:l},this.body=r.querySelector("body"),this.book=f,e.next=18,E(f);case 18:return this.bookExists=e.sent,e.abrupt("return",f);case 20:case"end":return e.stop()}var b}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"isAlreadyAdded",get:function(){return this.bookExists}}]),e}();function A(e,t){document.dispatchEvent(new CustomEvent(e,{detail:t}))}function C(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return{do:function(e){t.forEach((function(t){return document.addEventListener(t,e)}))}}}function N(){var e=o.a.createRef();return o.a.createElement("div",null,o.a.createElement(p.b,{floating:!0,primary:!0,style:{height:32,width:32,padding:6},onClick:function(){return e.current.click()}},"add"),o.a.createElement("input",{type:"file",id:"file-selector",onChange:function(e){var t=e.target.files[0],n=new FileReader;n.addEventListener("load",function(){var e=Object(k.a)(v.a.mark((function e(t){var n,a,r;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=t.target.result,a=new T(n),e.next=5,a.parseDescription();case 5:if(r=e.sent,!a.isAlreadyAdded){e.next=9;break}return A("book-already-added",{book:r}),e.abrupt("return");case 9:return A("book-adding",{book:r}),e.next=12,a.parseBody();case 12:A("book-added",{book:r}),e.next=18;break;case 15:e.prev=15,e.t0=e.catch(0),console.error("error when parsing",e.t0);case 18:case"end":return e.stop()}}),e,null,[[0,15]])})));return function(t){return e.apply(this,arguments)}}()),n.readAsText(t)},ref:e}))}n(107);function D(e){var t=Object(r.useState)([]),n=Object(y.a)(t,2),a=n[0],i=n[1],c=Object(r.useState)(null),s=Object(y.a)(c,2),l=s[0],u=s[1];C("book-adding").do((function(e){u(e.detail.book)})),C("book-added").do(function(){var e=Object(k.a)(v.a.mark((function e(t){return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return u(null),e.t0=i,e.next=4,O();case 4:e.t1=e.sent,(0,e.t0)(e.t1);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),Object(r.useEffect)((function(){Object(k.a)(v.a.mark((function e(){return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=i,e.next=3,O();case 3:return e.t1=e.sent,e.abrupt("return",(0,e.t0)(e.t1));case 5:case"end":return e.stop()}}),e)})))()}),[]);return o.a.createElement("div",null,o.a.createElement(N,null),o.a.createElement("br",null),o.a.createElement("div",{id:"list"},l&&o.a.createElement(p.c,{key:l.title,className:"loading"},o.a.createElement(p.f,{title:l.title,subtitle:l.author,avatar:o.a.createElement(p.a,{src:l.image,role:"presentation"})}),o.a.createElement(p.d,{expander:!0},o.a.createElement(p.b,{flat:!0},o.a.createElement("div",{className:"lds-dual-ring"})),o.a.createElement(p.b,{flat:!0},"Loading...")),o.a.createElement(p.e,{expandable:!0,expanded:!0},l.annotation)),a.map((function(t){return o.a.createElement(p.c,{key:t.title},o.a.createElement(p.f,{title:t.title,subtitle:t.author,avatar:o.a.createElement(p.a,{src:t.image,role:"presentation"})}),o.a.createElement(p.d,{expander:!0},o.a.createElement(p.b,{flat:!0,onClick:function(){return function(t){return e.history.push("/read/".concat(t.hashHex))}(t)}},"Read"),o.a.createElement(p.b,{flat:!0},"Delete")),o.a.createElement(p.e,{expandable:!0},t.annotation))}))))}var q=n(53),P=n(7),H=n(10),M=function(e){Object(m.a)(n,e);var t=Object(h.a)(n);function n(e){var a;return Object(u.a)(this,n),(a=t.call(this,e)).state={book:null,topSection:null},a}return Object(d.a)(n,[{key:"componentDidMount",value:function(){var e=Object(k.a)(v.a.mark((function e(){var t,n;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,j(this.props.match.params.hash);case 2:return t=e.sent,e.next=5,o=t.hashHex,a.getFromIndex("sections","parent",o);case 5:return n=e.sent,this.state.book=t,this.state.topSection=n,e.next=10,r=n.id,a.getAllFromIndex("sections","parent",r);case 10:this.state.children=e.sent,this.forceUpdate();case 12:case"end":return e.stop()}var r,o}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"render",value:function(){var e=this.state,t=e.book,n=e.topSection;e.children;return o.a.createElement("div",null,t&&o.a.createElement("div",null,o.a.createElement("h2",null,t.title),o.a.createElement("div",{style:{maxWidth:600}},o.a.createElement("div",null,o.a.createElement("img",{src:t.image,align:"left",style:{maxHeight:200,margin:8},alt:t.title}),t.annotation),o.a.createElement("br",null),o.a.createElement("h3",null,n.title))))}}]),n}(r.PureComponent),R=Object(H.a)(),B=function(e){Object(m.a)(n,e);var t=Object(h.a)(n);function n(){var e;return Object(u.a)(this,n),(e=t.call(this)).addToast=function(t,n){var a=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];e.setState((function(e){var r=e.toasts.slice();return r.push({text:t,action:n}),{toasts:r,autohide:a}}))},e.dismissToast=function(){var t=Object(l.a)(e.state.toasts).slice(1);e.setState({toasts:t})},e.setPage=function(t,n){e.navItems=e.navItems.map((function(e){return e.divider?e:Object(s.a)(Object(s.a)({},e),{},{active:e.key===t})})),e.setState({key:t,page:n})},e.hide=function(){e.setState({visible:!1,renderNode:null})},e.handleShow=function(){e.setState({renderNode:document.getElementById("navigation-drawer-demo")})},e.navItems=f.map((function(t){return t.divider?t:Object(s.a)(Object(s.a)({},t),{},{onClick:function(){return e.setPage(t.key,t.primaryText)}})})),e.state={toasts:[],renderNode:null,visible:!0,key:f[0].key,page:f[0].primaryText},C("book-already-added").do((function(t){var n=t.detail.book;e.addToast('Book "'.concat(n.title.toUpperCase(),'" has been added earlier!'))})),e}return Object(d.a)(n,[{key:"render",value:function(){var e=this.state,t=e.visible,n=e.renderNode,a=e.toasts;return o.a.createElement(q.a,{history:R,basename:"/fb2-reader"},o.a.createElement("div",null,o.a.createElement(p.g,{id:"navigation-drawer-demo","aria-label":"Navigation Drawer Demo",visible:t,fullPage:!0,focusOnMount:!1,onShow:this.handleShow,onHide:this.hide},o.a.createElement(p.i,{renderNode:n,navItems:this.navItems,mobileDrawerType:p.i.DrawerTypes.TEMPORARY_MINI,tabletDrawerType:p.i.DrawerTypes.PERSISTENT_MINI,desktopDrawerType:p.i.DrawerTypes.PERSISTENT_MINI,toolbarTitle:"FB2 Reader",toolbarActions:o.a.createElement(p.b,{icon:!0,onClick:this.hide},"close"),contentId:"main-demo-content",temporaryIcon:o.a.createElement(p.h,null,"menu"),persistentIcon:o.a.createElement(p.h,null,"arrow_back"),contentClassName:"md-grid"},o.a.createElement(P.d,null,o.a.createElement(P.b,{path:"/books",component:D}),o.a.createElement(P.b,{path:"/read/:hash",component:M}),o.a.createElement(P.a,{from:"/",to:"/books"}))),o.a.createElement(p.j,{id:"example-snackbar",toasts:a,autohide:!0,onDismiss:this.dismissToast,autohideTimeout:4e3}))))}}]),n}(r.PureComponent);Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));var F=n(55);n.n(F).a.load({google:{families:["Roboto:300,400,500,700","Material Icons"]}}),c.a.render(o.a.createElement(B,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))},58:function(e,t,n){e.exports=n(110)},63:function(e,t,n){},64:function(e,t,n){}},[[58,1,2]]]);
//# sourceMappingURL=main.f44bcd37.chunk.js.map