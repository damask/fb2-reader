(this["webpackJsonpfb2-reader-react"]=this["webpackJsonpfb2-reader-react"]||[]).push([[0],{104:function(e,t,n){},107:function(e,t,n){"use strict";n.r(t);var a,r=n(1),o=n.n(r),i=n(4),c=n.n(i),s=(n(60),n(24)),l=n(53),u=n(16),d=n(17),m=n(18),f=n(19),h=(n(61),n(6)),p=n(48),b=n.n(p),v=n(49),k=n.n(v),y=[{key:"books",primaryText:"Books",leftIcon:o.a.createElement(h.h,null,"book"),active:!0},{key:"read",primaryText:"Read",leftIcon:o.a.createElement(h.h,null,"assignment")},{key:"drafts",primaryText:"Drafts",leftIcon:o.a.createElement(h.h,null,"drafts")},{key:"trash",primaryText:"Trash",leftIcon:o.a.createElement(h.h,null,"delete")}],g=n(8),x=n.n(g),E=n(12),w=n(54),O=Object(w.a)("fb2-reader",1,{upgrade:function(e){e.createObjectStore("books",{keyPath:"hashHex",autoIncrement:!0}).createIndex("author","author"),e.createObjectStore("sections",{keyPath:"id",autoIncrement:!0}).createIndex("parent","parent"),e.createObjectStore("elements",{keyPath:["sectionId","ordinal"]}).createIndex("sectionId","sectionId")}});function I(e){return a.count("books",e.hashHex)}function j(e){return a.add("sections",e)}function S(e){return a.add("elements",e)}function T(){return a?a.getAll("books"):O.then((function(){return a.getAll("books")}))}function A(e){return a?a.get("books",e):O.then((function(){return a.get("books",e)}))}O.then((function(e){return a=e}));var C=function(){function e(t){Object(u.a)(this,e),this.xml=t}return Object(d.a)(e,[{key:"parseSection",value:function(){var e=Object(E.a)(x.a.mark((function e(t,n,a){var r,o,i,c,s,l,u,d;return x.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=t.querySelector("title"),c=t.querySelector("image"),s=t.querySelectorAll(":scope > *"),e.next=5,j({parent:n,ordinal:a,title:null!==(r=null===i||void 0===i?void 0:i.textContent)&&void 0!==r?r:null,image:null!==(o=null===c||void 0===c?void 0:c.href)&&void 0!==o?o:null});case 5:l=e.sent,u=0;case 7:if(!(u<s.length)){e.next=19;break}if("section"!==(d=s[u]).tagName){e.next=14;break}return e.next=12,this.parseSection(d,l,u);case 12:e.next=16;break;case 14:return e.next=16,S({tag:d.tagName,content:d.innerHTML,sectionId:l,ordinal:u});case 16:++u,e.next=7;break;case 19:case"end":return e.stop()}}),e,this)})));return function(t,n,a){return e.apply(this,arguments)}}()},{key:"parseBody",value:function(){var e=Object(E.a)(x.a.mark((function e(){var t,n,r,o,i,c,s,l,u;return x.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,d=this.book,a.add("books",d);case 2:return r=e.sent,o=this.body,i=o.querySelector("title"),c=o.querySelector("image"),s=o.querySelectorAll(":scope > section"),e.next=9,j({title:null!==(t=null===i||void 0===i?void 0:i.textContent)&&void 0!==t?t:null,image:null!==(n=null===c||void 0===c?void 0:c.href)&&void 0!==n?n:null,bookId:r});case 9:l=e.sent,u=0;case 11:if(!(u<s.length)){e.next=17;break}return e.next=14,this.parseSection(s[u],l,u);case 14:++u,e.next=11;break;case 17:case"end":return e.stop()}var d}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"parseDescription",value:function(){var e=Object(E.a)(x.a.mark((function e(){var t,n,a,r,o,i,c,s,l,u,d,m,f,h,p;return x.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,window.crypto.subtle.digest("SHA-512",new TextEncoder("utf-8").encode(this.xml));case 2:return t=e.sent,b=t,n=Array.prototype.map.call(new Uint8Array(b),(function(e){return("00"+e.toString(16)).slice(-2)})).join(""),a=new DOMParser,r=a.parseFromString(this.xml,"application/xml"),o=r.querySelector("description"),i=o.querySelector("author first-name").textContent+" "+o.querySelector("author last-name").textContent,c=o.querySelector("book-title"),s=(s=o.querySelector("annotation"))&&s.textContent,(u=o.querySelector("coverpage image"))&&(d=u.getAttribute("l:href"))&&/^#/.test(d)&&(m=d.slice(1),(f=r.querySelector('binary[id="'.concat(m,'"]')))&&(h=f.getAttribute("content-type"),l="data:".concat(h,";base64,").concat(f.innerHTML))),p={hashHex:n,author:i,title:c.textContent,annotation:s,image:l},this.body=r.querySelector("body"),this.book=p,e.next=18,I(p);case 18:return this.bookExists=e.sent,e.abrupt("return",p);case 20:case"end":return e.stop()}var b}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"isAlreadyAdded",get:function(){return this.bookExists}}]),e}();function D(e,t){document.dispatchEvent(new CustomEvent(e,{detail:t}))}function N(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return{do:function(e){t.forEach((function(t){return document.addEventListener(t,e)}))}}}var q=function(e){Object(f.a)(n,e);var t=Object(m.a)(n);function n(){var e;return Object(u.a)(this,n),(e=t.call(this)).change=function(t){var n=t.target.files[0];e.state.loading=!0;var a=new FileReader;a.addEventListener("load",function(){var t=Object(E.a)(x.a.mark((function t(n){var a,r,o;return x.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,a=n.target.result,r=new C(a),t.next=5,r.parseDescription();case 5:if(o=t.sent,!r.isAlreadyAdded){t.next=9;break}return D("book-already-added",{book:o}),t.abrupt("return");case 9:return D("book-adding",{book:o}),t.next=12,r.parseBody();case 12:D("book-added",{book:o}),t.next=18;break;case 15:t.prev=15,t.t0=t.catch(0),console.error("error when parsing",t.t0);case 18:return t.prev=18,e.state.loading=!1,t.finish(18);case 21:case"end":return t.stop()}}),t,null,[[0,15,18,21]])})));return function(e){return t.apply(this,arguments)}}()),a.readAsText(n)},e.state={loading:!1},e.fileInput=o.a.createRef(),e}return Object(d.a)(n,[{key:"render",value:function(){var e=this;return o.a.createElement("div",null,o.a.createElement(h.b,{floating:!0,primary:!0,style:{height:32,width:32,padding:6},onClick:function(){return e.fileInput.current.click()}},"add"),o.a.createElement("input",{type:"file",id:"file-selector",onChange:this.change,ref:this.fileInput}))}}]),n}(r.PureComponent),P=(n(104),function(e){Object(f.a)(n,e);var t=Object(m.a)(n);function n(){var e;return Object(u.a)(this,n),(e=t.call(this)).readBook=function(e){localStorage.setItem("READ_BOOK",e.hashHex)},e.state={adding:!1,books:[],book:null},N("book-adding").do((function(t){e.state.adding=!0,e.state.book=t.detail.book,e.forceUpdate()})),N("book-added").do(function(){var t=Object(E.a)(x.a.mark((function t(n){return x.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.state.books.push(n.detail.book),e.state.book=null,t.next=4,T();case 4:e.state.books=t.sent,e.state.adding=!1,e.forceUpdate();case 7:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()),e}return Object(d.a)(n,[{key:"componentDidMount",value:function(){var e=Object(E.a)(x.a.mark((function e(){return x.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,T();case 2:this.state.books=e.sent,this.forceUpdate();case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"render",value:function(){var e=this,t=this.state,n=t.books,a=t.book,r=t.adding;return o.a.createElement("div",null,o.a.createElement(q,null),o.a.createElement("br",null),o.a.createElement("div",{id:"list"},r&&o.a.createElement(h.c,{key:a.title,className:"loading"},o.a.createElement(h.f,{title:a.title,subtitle:a.author,avatar:o.a.createElement(h.a,{src:a.image,role:"presentation"})}),o.a.createElement(h.d,{expander:!0},o.a.createElement(h.b,{flat:!0},o.a.createElement("div",{className:"lds-dual-ring"})),o.a.createElement(h.b,{flat:!0},"Loading...")),o.a.createElement(h.e,{expandable:!0,expanded:!0},a.annotation)),n.map((function(t){return o.a.createElement(h.c,{key:t.title},o.a.createElement(h.f,{title:t.title,subtitle:t.author,avatar:o.a.createElement(h.a,{src:t.image,role:"presentation"})}),o.a.createElement(h.d,{expander:!0},o.a.createElement(h.b,{flat:!0,onClick:e.readBook(t)},"Read"),o.a.createElement(h.b,{flat:!0},"Delete")),o.a.createElement(h.e,{expandable:!0},t.annotation))}))))}}]),n}(r.PureComponent)),B=n(50),M=n(7),R=n(10),H=function(e){Object(f.a)(n,e);var t=Object(m.a)(n);function n(e){var a;return Object(u.a)(this,n),(a=t.call(this,e)).state={book:null},a}return Object(d.a)(n,[{key:"componentDidMount",value:function(){var e=Object(E.a)(x.a.mark((function e(){return x.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,A(this.props.match.params.hash);case 2:this.state.book=e.sent,this.forceUpdate();case 4:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"render",value:function(){var e=this.state.book;return o.a.createElement("div",null,e&&o.a.createElement("div",{style:{maxWidth:600}},o.a.createElement("h1",null,e.title),o.a.createElement("div",null,o.a.createElement("img",{src:e.image,align:"left",style:{maxHeight:200,margin:4}}),e.annotation)))}}]),n}(r.PureComponent),U=Object(R.a)(),L=function(e){Object(f.a)(n,e);var t=Object(m.a)(n);function n(){var e;return Object(u.a)(this,n),(e=t.call(this)).addToast=function(t,n){var a=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];e.setState((function(e){var r=e.toasts.slice();return r.push({text:t,action:n}),{toasts:r,autohide:a}}))},e.dismissToast=function(){var t=Object(l.a)(e.state.toasts).slice(1);e.setState({toasts:t})},e.setPage=function(t,n){e.navItems=e.navItems.map((function(e){return e.divider?e:Object(s.a)({},e,{active:e.key===t})})),e.setState({key:t,page:n})},e.hide=function(){e.setState({visible:!1,renderNode:null})},e.handleShow=function(){e.setState({renderNode:document.getElementById("navigation-drawer-demo")})},e.navItems=y.map((function(t){return t.divider?t:Object(s.a)({},t,{onClick:function(){return e.setPage(t.key,t.primaryText)}})})),e.state={toasts:[],renderNode:null,visible:!0,key:y[0].key,page:y[0].primaryText},N("book-already-added").do((function(t){var n=t.detail.book;e.addToast('Book "'.concat(n.title.toUpperCase(),'" has been added earlier!'))})),e}return Object(d.a)(n,[{key:"render",value:function(){var e=this.state,t=e.visible,n=e.renderNode,a=e.toasts;return o.a.createElement(B.a,{history:U,basename:"/fb2-reader"},o.a.createElement("div",null,o.a.createElement(h.g,{id:"navigation-drawer-demo","aria-label":"Navigation Drawer Demo",visible:t,fullPage:!0,focusOnMount:!1,onShow:this.handleShow,onHide:this.hide},o.a.createElement(h.i,{renderNode:n,navItems:this.navItems,mobileDrawerType:h.i.DrawerTypes.TEMPORARY_MINI,tabletDrawerType:h.i.DrawerTypes.PERSISTENT_MINI,desktopDrawerType:h.i.DrawerTypes.PERSISTENT_MINI,toolbarTitle:"FB2 Reader",toolbarActions:o.a.createElement(h.b,{icon:!0,onClick:this.hide},"close"),contentId:"main-demo-content",temporaryIcon:o.a.createElement(h.j,{use:b.a.url}),persistentIcon:o.a.createElement(h.j,{use:k.a.url}),contentClassName:"md-grid"},o.a.createElement(M.d,null,o.a.createElement(M.b,{path:"/books",component:P}),o.a.createElement(M.b,{path:"/read/:hash",component:H}),o.a.createElement(M.a,{from:"/",to:"/books"}))),o.a.createElement(h.k,{id:"example-snackbar",toasts:a,autohide:!0,onDismiss:this.dismissToast,autohideTimeout:4e3}))))}}]),n}(r.PureComponent);Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));var _=n(52);n.n(_).a.load({google:{families:["Roboto:300,400,500,700","Material Icons"]}}),c.a.render(o.a.createElement(L,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))},48:function(e,t,n){e.exports=n.p+"static/media/menu.204f61a1.svg"},49:function(e,t,n){e.exports=n.p+"static/media/arrow_back.98abdde4.svg"},55:function(e,t,n){e.exports=n(107)},60:function(e,t,n){},61:function(e,t,n){}},[[55,1,2]]]);
//# sourceMappingURL=main.d2bfed5f.chunk.js.map