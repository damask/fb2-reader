{"version":3,"sources":["db.js","constants/inboxListItems.jsx","fb2Parser.js","events.js","components/BookImporter.js","components/BookList.js","components/Reader.js","App.js","serviceWorker.js","index.js"],"names":["db","key","primaryText","leftIcon","active","openedDb","openDB","upgrade","createObjectStore","keyPath","autoIncrement","createIndex","bookExists","book","count","hashHex","addSection","section","add","addElement","element","getAllBooks","getAll","then","getBook","hash","get","x","Fb2Parser","xml","this","parentSectionId","sectionOrdinal","title","querySelector","image","elements","querySelectorAll","parent","ordinal","textContent","href","id","i","length","tagName","parseSection","tag","content","innerHTML","sectionId","bookId","body","sections","window","crypto","subtle","digest","TextEncoder","encode","buffer","Array","prototype","map","call","Uint8Array","toString","slice","join","parser","DOMParser","doc","parseFromString","description","author","annotation","imageInfo","imageHref","getAttribute","test","imageBinary","type","dispatch","detail","document","dispatchEvent","CustomEvent","on","types","do","subscription","forEach","addEventListener","BookImporter","change","event","file","target","files","state","loading","reader","FileReader","a","result","parseDescription","isAlreadyAdded","Events","parseBody","console","error","readAsText","fileInput","React","createRef","floating","primary","style","height","width","padding","onClick","current","click","onChange","ref","PureComponent","BookList","readBook","props","history","push","adding","books","forceUpdate","className","subtitle","avatar","src","role","expander","flat","expandable","expanded","Reader","topSection","match","params","hasHex","getFromIndex","getAllFromIndex","children","maxWidth","align","maxHeight","margin","alt","createBrowserHistory","App","addToast","text","action","autohide","setState","toasts","dismissToast","setPage","page","navItems","item","divider","hide","visible","renderNode","handleShow","getElementById","inboxListItems","toUpperCase","basename","aria-label","fullPage","focusOnMount","onShow","onHide","mobileDrawerType","NavigationDrawer","DrawerTypes","TEMPORARY_MINI","tabletDrawerType","PERSISTENT_MINI","desktopDrawerType","toolbarTitle","toolbarActions","icon","contentId","temporaryIcon","persistentIcon","contentClassName","path","component","from","to","onDismiss","autohideTimeout","Boolean","location","hostname","WebFontLoader","load","google","families","ReactDOM","render","navigator","serviceWorker","ready","registration","unregister","catch","message"],"mappings":"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","file":"static/js/main.7aac4f6c.chunk.js","sourcesContent":["import {openDB} from 'idb';\n\nconst BOOKS = 'books';\nconst SECTIONS = 'sections';\nconst ELEMENTS = 'elements';\n\nlet db;\n\nconst openedDb = openDB('fb2-reader', 1, {\n    upgrade(db) {\n        // Create a store of objects\n        const books = db.createObjectStore(BOOKS, {\n            keyPath: 'hashHex', autoIncrement: true\n        });\n        books.createIndex('author', 'author');\n\n        const sections = db.createObjectStore(SECTIONS, {\n            keyPath: 'id', autoIncrement: true\n        });\n        sections.createIndex('parent', 'parent');\n\n        const elements = db.createObjectStore(ELEMENTS, {\n            keyPath: ['sectionId', 'ordinal']\n        });\n        elements.createIndex('sectionId', 'sectionId');\n\n    }\n});\n\nopenedDb.then(x => db = x);\n\nexport function addBook(book) {\n    return db.add(BOOKS, book);\n}\n\nexport function bookExists(book) {\n    return db.count(BOOKS, book.hashHex);\n}\n\nexport function addSection(section) {\n    return db.add(SECTIONS, section);\n}\n\nexport function addElement(element) {\n    return db.add(ELEMENTS, element);\n}\n\nexport function getAllBooks() {\n    if (db) {\n        return db.getAll(BOOKS);\n    }\n    return openedDb.then(() => db.getAll(BOOKS));\n}\n\nexport function getBook(hash) {\n    if (db) {\n        return db.get(BOOKS, hash);\n    }\n    return openedDb.then(() => db.get(BOOKS, hash));\n}\n\nexport function getRootSection() {\n    if (db) {\n        return db.getFromIndex(SECTIONS, 'parent', -1);\n    }\n    return openedDb.then(() => db.getFromIndex(SECTIONS, 'parent', -1));\n}\n\nexport function getSections(parent) {\n    return db.getAllFromIndex(SECTIONS, 'parent', parent);\n}\n","import React from 'react';\nimport { FontIcon } from 'react-md';\n\nexport default [{\n  key: 'books',\n  primaryText: 'Books',\n  leftIcon: <FontIcon>book</FontIcon>,\n  active: true,\n}, {\n  key: 'read',\n  primaryText: 'Read',\n  leftIcon: <FontIcon>assignment</FontIcon>,\n},{\n  key: 'drafts',\n  primaryText: 'Drafts',\n  leftIcon: <FontIcon>drafts</FontIcon>,\n}, {\n  key: 'trash',\n  primaryText: 'Trash',\n  leftIcon: <FontIcon>delete</FontIcon>,\n}];\n","import {addSection, addElement, addBook, bookExists} from \"./db.js\";\n\nfunction buf2hex(buffer) { // buffer is an ArrayBuffer\n    return Array.prototype.map.call(new Uint8Array(buffer), x => ('00' + x.toString(16)).slice(-2)).join('');\n}\n\nexport class Fb2Parser {\n    xml;\n    body;\n    book;\n    bookExists;\n\n    constructor(xml) {\n         this.xml = xml;\n    }\n\n    async parseSection(section, parentSectionId, sectionOrdinal) {\n        //  <p>, <image>, <poem>, <subtitle>, <cite>, <empty-line/>, <table>\n\n        const title = section.querySelector('title');\n        const image = section.querySelector('image');\n        const elements = section.querySelectorAll(':scope > *');\n\n        const id = await addSection({parent: parentSectionId, ordinal: sectionOrdinal,\n            title: title?.textContent ?? null, image: image?.href ?? null });\n\n        for (let i = 0; i < elements.length; ++i) {\n            const element = elements[i];\n            if (element.tagName === 'section') {\n                await this.parseSection(element, id, i);\n            } else {\n                await addElement({tag: element.tagName, content: element.innerHTML, sectionId: id, ordinal: i })\n            }\n        }\n    }\n\n    async parseBody() {\n        const bookId = await addBook(this.book);\n\n        // image, title, epigraph, section\n        const body = this.body;\n\n        const title = body.querySelector('title');\n        const image = body.querySelector('image');\n        const sections = body.querySelectorAll(':scope > section');\n\n        const id = await addSection({title: title?.textContent ?? null, image: image?.href ?? null, parent: -1, bookId });\n        for (let i = 0; i < sections.length; ++i) {\n            await this.parseSection(sections[i], id, i);\n        }\n    }\n\n    async parseDescription() {\n        const hash = await window.crypto.subtle.digest(\"SHA-512\", new TextEncoder(\"utf-8\").encode(this.xml));\n        const hashHex = buf2hex(hash);\n\n        const parser = new DOMParser();\n        const doc = parser.parseFromString(this.xml, \"application/xml\");\n        const description = doc.querySelector('description');\n\n        const author = description.querySelector('author first-name').textContent + ' ' +\n            description.querySelector('author last-name').textContent;\n        const title = description.querySelector('book-title');\n\n        let annotation = description.querySelector('annotation');\n        annotation = annotation && annotation.textContent;\n\n        // image\n        let image;\n        const imageInfo = description.querySelector('coverpage image');\n        if (imageInfo) {\n            const imageHref = imageInfo.getAttribute('l:href');\n            if (imageHref && /^#/.test(imageHref)) {\n                const id = imageHref.slice(1);\n                const imageBinary = doc.querySelector(`binary[id=\"${id}\"]`);\n                if (imageBinary) {\n                    const type = imageBinary.getAttribute('content-type');\n                    image = `data:${type};base64,${imageBinary.innerHTML}`;\n                }\n            }\n        }\n\n\n        const book = {hashHex, author: author, title: title.textContent, annotation, image};\n\n        this.body = doc.querySelector('body');\n        this.book = book;\n        this.bookExists = await bookExists(book);\n        return book;\n    }\n\n    get isAlreadyAdded() {\n        return this.bookExists;\n    }\n\n}\n\n","export const DB_READY = 'db-ready';\nexport const BOOK_ALREADY_ADDED = 'book-already-added';\nexport const BOOK_ADDING = 'book-adding';\nexport const BOOK_ADDED = 'book-added';\n\nexport function dispatch(type, detail) {\n    document.dispatchEvent(new CustomEvent(type, { detail }));\n}\n\nexport function on(...types) {\n    return {\n        do (subscription) {\n            types.forEach(type => document.addEventListener(type, subscription));\n        }\n    };\n}\n\n\n","import React, {PureComponent} from 'react';\r\nimport {Button} from \"react-md\";\r\nimport {Fb2Parser} from \"../fb2Parser\";\r\nimport * as Events from \"../events\";\r\n\r\nexport class BookImporter extends PureComponent {\r\n    constructor() {\r\n        super();\r\n        this.state = {\r\n            loading: false\r\n        };\r\n\r\n        this.fileInput = React.createRef();\r\n    }\r\n\r\n    change = (event) => {\r\n        const file = event.target.files[0];\r\n        // eslint-disable-next-line\r\n        this.state.loading = true;\r\n        const reader = new FileReader();\r\n        reader.addEventListener('load', async event => {\r\n            try {\r\n                const xml = event.target.result;\r\n                const parser = new Fb2Parser(xml);\r\n                const book = await parser.parseDescription();\r\n\r\n                if (parser.isAlreadyAdded) {\r\n                    Events.dispatch(Events.BOOK_ALREADY_ADDED, {book});\r\n                    return;\r\n                }\r\n\r\n                Events.dispatch(Events.BOOK_ADDING, {book});\r\n                await parser.parseBody();\r\n                Events.dispatch(Events.BOOK_ADDED, {book});\r\n            } catch (e) {\r\n                console.error('error when parsing', e);\r\n            } finally {\r\n                // eslint-disable-next-line react/no-direct-mutation-state\r\n                this.state.loading = false;\r\n            }\r\n        });\r\n        reader.readAsText(file);\r\n    }\r\n\r\n    render() {\r\n        return (\r\n            <div>\r\n                <Button floating primary style={{height: 32, width: 32, padding: 6}} onClick={() => this.fileInput.current.click()}>add</Button>\r\n                <input type=\"file\" id=\"file-selector\" onChange={this.change} ref={this.fileInput}/>\r\n            </div>\r\n        );\r\n    }\r\n}\r\n","import React from 'react';\r\nimport {PureComponent} from \"react\";\r\nimport {getAllBooks} from \"../db\";\r\nimport {BookImporter} from \"./BookImporter\";\r\nimport * as Events from \"../events\";\r\nimport {\r\n    Avatar,\r\n    Button,\r\n    Card,\r\n    CardActions,\r\n    CardText,\r\n    CardTitle,\r\n} from 'react-md';\r\nimport './BookList.css';\r\n\r\nexport class BookList extends PureComponent {\r\n    constructor() {\r\n        super();\r\n\r\n        this.state = {\r\n            adding: false,\r\n            books: [],\r\n            book: null\r\n        };\r\n\r\n        Events.on(Events.BOOK_ADDING).do(event => {\r\n            this.state.adding = true;\r\n            this.state.book = event.detail.book;\r\n            this.forceUpdate();\r\n        });\r\n        Events.on(Events.BOOK_ADDED).do(async event => {\r\n            this.state.books.push(event.detail.book);\r\n            this.state.book = null;\r\n            this.state.books = await getAllBooks();\r\n            this.state.adding = false;\r\n            this.forceUpdate();\r\n        });\r\n    }\r\n\r\n    async componentDidMount() {\r\n        this.state.books = await getAllBooks();\r\n        this.forceUpdate();\r\n    }\r\n\r\n    readBook = book => {\r\n        this.props.history.push(`/read/${book.hashHex}`);\r\n    }\r\n\r\n    render() {\r\n        let { books, book, adding } = this.state;\r\n        return (\r\n            <div>\r\n                <BookImporter></BookImporter><br/>\r\n                <div id=\"list\">\r\n                    {\r\n                        adding &&\r\n                        <Card key={book.title} className=\"loading\">\r\n                            <CardTitle title={book.title}\r\n                                       subtitle={book.author}\r\n                                       avatar={<Avatar src={book.image} role=\"presentation\"/>}\r\n                            />\r\n                            <CardActions expander>\r\n                                <Button flat>\r\n                                    <div className=\"lds-dual-ring\"></div>\r\n                                </Button>\r\n                                <Button flat>\r\n                                    Loading...\r\n                                </Button>\r\n                            </CardActions>\r\n                            <CardText expandable expanded={true}>\r\n                                {book.annotation}\r\n                            </CardText>\r\n                        </Card>\r\n                    }\r\n                    {\r\n                    books.map(book =>\r\n                        <Card key={book.title}>\r\n                            <CardTitle\r\n                                title={book.title}\r\n                                subtitle={book.author}\r\n                                avatar={<Avatar src={book.image} role=\"presentation\" />}\r\n                            />\r\n                            <CardActions expander>\r\n                                <Button flat onClick={() => this.readBook(book)}>Read</Button>\r\n                                <Button flat>Delete</Button>\r\n                            </CardActions>\r\n                            <CardText expandable>\r\n                                {book.annotation}\r\n                            </CardText>\r\n                        </Card>\r\n                    )\r\n                }</div>\r\n            </div>\r\n        );\r\n    }\r\n}\r\n\r\n","import React from 'react';\r\nimport {PureComponent} from \"react\";\r\nimport {getBook, getRootSection, getSections} from \"../db\";\r\n\r\nexport class Reader extends PureComponent {\r\n    constructor(props) {\r\n        super(props);\r\n\r\n        this.state = {\r\n            book: null,\r\n            topSection: null\r\n        };\r\n    }\r\n\r\n    async componentDidMount() {\r\n        const book = await getBook(this.props.match.params.hash);\r\n        const topSection = await getRootSection(book.hasHex);\r\n        this.state.book = book;\r\n        this.state.topSection =\r\n        this.state.children = await getSections(topSection.id);\r\n        this.forceUpdate();\r\n    }\r\n\r\n    render() {\r\n        const { book, topSection, children } = this.state;\r\n        debugger\r\n        return (\r\n            <div>\r\n                { book &&\r\n                    <div style={{maxWidth: 600}}>\r\n                        <h1>{book.title}</h1>\r\n                        <div><img src={book.image} align=\"left\" style={{maxHeight:200, margin: 4}} alt={book.title}/>{book.annotation}</div>\r\n                        <h3>{topSection.title}</h3>\r\n                    </div>\r\n                }\r\n            </div>\r\n        )\r\n    }\r\n}\r\n","/* eslint-disable react/no-array-index-key */\nimport React, {PureComponent} from 'react';\nimport './App.css';\nimport {Button, DialogContainer, FontIcon, NavigationDrawer, Snackbar} from 'react-md';\nimport inboxListItems from './constants/inboxListItems';\nimport {BookList} from './components/BookList';\nimport * as Events from \"./events\";\n\n\nimport {BrowserRouter, Redirect, Route, Switch} from \"react-router-dom\";\n\nimport {createBrowserHistory} from 'history';\nimport {Reader} from \"./components/Reader\";\n\n// создаём кастомную историю\nconst history = createBrowserHistory();\n\nexport default class App extends PureComponent {\n    constructor() {\n        super();\n\n        // Update the items so they have an onClick handler to change the current page\n        this.navItems = inboxListItems.map((item) => {\n            if (item.divider) {\n                return item;\n            }\n\n            return {\n                ...item,\n                onClick: () => this.setPage(item.key, item.primaryText),\n            };\n        });\n\n        this.state = {\n            toasts: [],\n            renderNode: null,\n            visible: true,\n            key: inboxListItems[0].key,\n            page: inboxListItems[0].primaryText,\n        };\n\n        Events.on(Events.BOOK_ALREADY_ADDED).do(event => {\n            const book = event.detail.book;\n            debugger\n            this.addToast(`Book \"${book.title.toUpperCase()}\" has been added earlier!`);\n        });\n    }\n\n    addToast = (text, action, autohide = true) => {\n        this.setState((state) => {\n            const toasts = state.toasts.slice();\n            toasts.push({text, action});\n            return {toasts, autohide};\n        });\n    }\n\n    dismissToast = () => {\n        const [, ...toasts] = this.state.toasts;\n        this.setState({toasts});\n    };\n\n    setPage = (key, page) => {\n        this.navItems = this.navItems.map((item) => {\n            if (item.divider) {\n                return item;\n            }\n\n            return {...item, active: item.key === key};\n        });\n\n        this.setState({key, page});\n    };\n\n    hide = () => {\n        this.setState({visible: false, renderNode: null});\n    };\n\n    handleShow = () => {\n        this.setState({renderNode: document.getElementById('navigation-drawer-demo')});\n    };\n\n    render() {\n        const {visible, renderNode, toasts} = this.state;\n        return (\n            <BrowserRouter history={history} basename={'/fb2-reader'}>\n                <div>\n                    <DialogContainer\n                        id=\"navigation-drawer-demo\"\n                        aria-label=\"Navigation Drawer Demo\"\n                        visible={visible}\n                        fullPage\n                        focusOnMount={false}\n                        onShow={this.handleShow}\n                        onHide={this.hide}>\n                        <NavigationDrawer\n                            renderNode={renderNode}\n                            navItems={this.navItems}\n                            mobileDrawerType={NavigationDrawer.DrawerTypes.TEMPORARY_MINI}\n                            tabletDrawerType={NavigationDrawer.DrawerTypes.PERSISTENT_MINI}\n                            desktopDrawerType={NavigationDrawer.DrawerTypes.PERSISTENT_MINI}\n                            toolbarTitle=\"FB2 Reader\"\n                            toolbarActions={<Button icon onClick={this.hide}>close</Button>}\n                            contentId=\"main-demo-content\"\n                            temporaryIcon={<FontIcon>menu</FontIcon>}\n                            persistentIcon={<FontIcon>arrow_back</FontIcon>}\n                            contentClassName=\"md-grid\">\n\n                            <Switch>\n                                <Route path='/books' component={BookList}/>\n                                <Route path='/read/:hash' component={Reader}/>\n                                <Redirect from='/' to='/books'/>\n                            </Switch>\n\n                        </NavigationDrawer>\n                        <Snackbar\n                            id=\"example-snackbar\"\n                            toasts={toasts}\n                            autohide={true}\n                            onDismiss={this.dismissToast}\n                            autohideTimeout={4000}\n                        />\n                    </DialogContainer>\n                </div>\n            </BrowserRouter>\n        );\n    }\n}\n","// This optional code is used to register a service worker.\n// register() is not called by default.\n\n// This lets the app load faster on subsequent visits in production, and gives\n// it offline capabilities. However, it also means that developers (and users)\n// will only see deployed updates on subsequent visits to a page, after all the\n// existing tabs open on the page have been closed, since previously cached\n// resources are updated in the background.\n\n// To learn more about the benefits of this model and instructions on how to\n// opt-in, read https://bit.ly/CRA-PWA\n\nconst isLocalhost = Boolean(\n  window.location.hostname === 'localhost' ||\n    // [::1] is the IPv6 localhost address.\n    window.location.hostname === '[::1]' ||\n    // 127.0.0.0/8 are considered localhost for IPv4.\n    window.location.hostname.match(\n      /^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/\n    )\n);\n\nexport function register(config) {\n  if (process.env.NODE_ENV === 'production' && 'serviceWorker' in navigator) {\n    // The URL constructor is available in all browsers that support SW.\n    const publicUrl = new URL(process.env.PUBLIC_URL, window.location.href);\n    if (publicUrl.origin !== window.location.origin) {\n      // Our service worker won't work if PUBLIC_URL is on a different origin\n      // from what our page is served on. This might happen if a CDN is used to\n      // serve assets; see https://github.com/facebook/create-react-app/issues/2374\n      return;\n    }\n\n    window.addEventListener('load', () => {\n      const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;\n\n      if (isLocalhost) {\n        // This is running on localhost. Let's check if a service worker still exists or not.\n        checkValidServiceWorker(swUrl, config);\n\n        // Add some additional logging to localhost, pointing developers to the\n        // service worker/PWA documentation.\n        navigator.serviceWorker.ready.then(() => {\n          console.log(\n            'This web app is being served cache-first by a service ' +\n              'worker. To learn more, visit https://bit.ly/CRA-PWA'\n          );\n        });\n      } else {\n        // Is not localhost. Just register service worker\n        registerValidSW(swUrl, config);\n      }\n    });\n  }\n}\n\nfunction registerValidSW(swUrl, config) {\n  navigator.serviceWorker\n    .register(swUrl)\n    .then(registration => {\n      registration.onupdatefound = () => {\n        const installingWorker = registration.installing;\n        if (installingWorker == null) {\n          return;\n        }\n        installingWorker.onstatechange = () => {\n          if (installingWorker.state === 'installed') {\n            if (navigator.serviceWorker.controller) {\n              // At this point, the updated precached content has been fetched,\n              // but the previous service worker will still serve the older\n              // content until all client tabs are closed.\n              console.log(\n                'New content is available and will be used when all ' +\n                  'tabs for this page are closed. See https://bit.ly/CRA-PWA.'\n              );\n\n              // Execute callback\n              if (config && config.onUpdate) {\n                config.onUpdate(registration);\n              }\n            } else {\n              // At this point, everything has been precached.\n              // It's the perfect time to display a\n              // \"Content is cached for offline use.\" message.\n              console.log('Content is cached for offline use.');\n\n              // Execute callback\n              if (config && config.onSuccess) {\n                config.onSuccess(registration);\n              }\n            }\n          }\n        };\n      };\n    })\n    .catch(error => {\n      console.error('Error during service worker registration:', error);\n    });\n}\n\nfunction checkValidServiceWorker(swUrl, config) {\n  // Check if the service worker can be found. If it can't reload the page.\n  fetch(swUrl, {\n    headers: { 'Service-Worker': 'script' },\n  })\n    .then(response => {\n      // Ensure service worker exists, and that we really are getting a JS file.\n      const contentType = response.headers.get('content-type');\n      if (\n        response.status === 404 ||\n        (contentType != null && contentType.indexOf('javascript') === -1)\n      ) {\n        // No service worker found. Probably a different app. Reload the page.\n        navigator.serviceWorker.ready.then(registration => {\n          registration.unregister().then(() => {\n            window.location.reload();\n          });\n        });\n      } else {\n        // Service worker found. Proceed as normal.\n        registerValidSW(swUrl, config);\n      }\n    })\n    .catch(() => {\n      console.log(\n        'No internet connection found. App is running in offline mode.'\n      );\n    });\n}\n\nexport function unregister() {\n  if ('serviceWorker' in navigator) {\n    navigator.serviceWorker.ready\n      .then(registration => {\n        registration.unregister();\n      })\n      .catch(error => {\n        console.error(error.message);\n      });\n  }\n}\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport App from './App';\nimport * as serviceWorker from './serviceWorker';\nimport WebFontLoader from 'webfontloader';\n\nWebFontLoader.load({\n    google: {\n        families: ['Roboto:300,400,500,700', 'Material Icons'],\n    },\n});\n\n\nReactDOM.render(\n  <App />,\n  document.getElementById('root')\n);\n\n// If you want your app to work offline and load faster, you can change\n// unregister() to register() below. Note this comes with some pitfalls.\n// Learn more about service workers: https://bit.ly/CRA-PWA\nserviceWorker.unregister();\n"],"sourceRoot":""}