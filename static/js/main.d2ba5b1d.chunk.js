(this["webpackJsonpfb2-reader-react"]=this["webpackJsonpfb2-reader-react"]||[]).push([[0],{107:function(e,t,n){},110:function(e,t,n){"use strict";n.r(t);var a,r=n(1),o=n.n(r),c=n(4),i=n.n(c),s=(n(63),n(17)),l=n(55),u=n(27),d=n(28),f=n(56),m=n(54),p=(n(64),n(6)),h=[{key:"books",primaryText:"Books",leftIcon:o.a.createElement(p.h,null,"book"),active:!0},{key:"read",primaryText:"Read",leftIcon:o.a.createElement(p.h,null,"assignment")},{key:"drafts",primaryText:"Drafts",leftIcon:o.a.createElement(p.h,null,"drafts")},{key:"trash",primaryText:"Trash",leftIcon:o.a.createElement(p.h,null,"delete")}],b=n(7),v=n.n(b),y=n(10),k=n(20),x=n(57),E=Object(x.a)("fb2-reader",1,{upgrade:function(e){e.createObjectStore("books",{keyPath:"hashHex",autoIncrement:!0}).createIndex("author","author"),e.createObjectStore("sections",{keyPath:"id",autoIncrement:!0}).createIndex("parent","parent"),e.createObjectStore("elements",{keyPath:["sectionId","ordinal"]}).createIndex("sectionId","sectionId")}});function g(e){return a.count("books",e.hashHex)}function w(e){return a.add("sections",e)}function O(e){return a.add("elements",e)}function S(){return a?a.getAll("books"):E.then((function(){return a.getAll("books")}))}function j(e){return a?a.get("books",e):E.then((function(){return a.get("books",e)}))}function I(e){return a?a.getFromIndex("sections","parent",e):E.then((function(){return a.getFromIndex("sections","parent",e)}))}E.then((function(e){return a=e}));var T=n(37);var A=function(){function e(t){Object(u.a)(this,e),this.xml=t,this.ordinal=0}return Object(d.a)(e,[{key:"parseSection",value:function(){var e=Object(y.a)(v.a.mark((function e(t,n){var a,r,o,c,i,s,l,u,d;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=t.querySelector("title"),c=t.querySelector("image"),i=t.querySelectorAll(":scope > *"),e.next=5,w({parent:n,ordinal:this.ordinal++,title:null!==(a=null===o||void 0===o?void 0:o.textContent)&&void 0!==a?a:null,image:null!==(r=null===c||void 0===c?void 0:c.href)&&void 0!==r?r:null});case 5:s=e.sent,l=Object(T.a)(i),e.prev=7,l.s();case 9:if((u=l.n()).done){e.next=20;break}if("section"!==(d=u.value).tagName){e.next=16;break}return e.next=14,this.parseSection(d,s);case 14:e.next=18;break;case 16:return e.next=18,O({tag:d.tagName,content:d.innerHTML,sectionId:s,ordinal:this.ordinal++});case 18:e.next=9;break;case 20:e.next=25;break;case 22:e.prev=22,e.t0=e.catch(7),l.e(e.t0);case 25:return e.prev=25,l.f(),e.finish(25);case 28:case"end":return e.stop()}}),e,this,[[7,22,25,28]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"parseBody",value:function(){var e=Object(y.a)(v.a.mark((function e(){var t,n,r,o,c,i,s,l,u,d,f;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,m=this.book,a.add("books",m);case 2:return r=e.sent,o=this.body,c=o.querySelector("title"),i=o.querySelector("image"),s=o.querySelectorAll(":scope > section"),e.next=9,w({title:null!==(t=null===c||void 0===c?void 0:c.textContent)&&void 0!==t?t:null,image:null!==(n=null===i||void 0===i?void 0:i.href)&&void 0!==n?n:null,ordinal:this.ordinal++,parent:r});case 9:l=e.sent,u=Object(T.a)(s),e.prev=11,u.s();case 13:if((d=u.n()).done){e.next=19;break}return f=d.value,e.next=17,this.parseSection(f,l);case 17:e.next=13;break;case 19:e.next=24;break;case 21:e.prev=21,e.t0=e.catch(11),u.e(e.t0);case 24:return e.prev=24,u.f(),e.finish(24);case 27:case"end":return e.stop()}var m}),e,this,[[11,21,24,27]])})));return function(){return e.apply(this,arguments)}}()},{key:"parseDescription",value:function(){var e=Object(y.a)(v.a.mark((function e(){var t,n,a,r,o,c,i,s,l,u,d,f,m,p,h;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,window.crypto.subtle.digest("SHA-512",new TextEncoder("utf-8").encode(this.xml));case 2:return t=e.sent,b=t,n=Array.prototype.map.call(new Uint8Array(b),(function(e){return("00"+e.toString(16)).slice(-2)})).join(""),a=new DOMParser,r=a.parseFromString(this.xml,"application/xml"),o=r.querySelector("description"),c=o.querySelector("author first-name").textContent+" "+o.querySelector("author last-name").textContent,i=o.querySelector("book-title"),s=(s=o.querySelector("annotation"))&&s.textContent,(u=o.querySelector("coverpage image"))&&(d=u.getAttribute("l:href"))&&/^#/.test(d)&&(f=d.slice(1),(m=r.querySelector('binary[id="'.concat(f,'"]')))&&(p=m.getAttribute("content-type"),l="data:".concat(p,";base64,").concat(m.innerHTML))),h={hashHex:n,author:c,title:i.textContent,annotation:s,image:l},this.body=r.querySelector("body"),this.book=h,e.next=18,g(h);case 18:return this.bookExists=e.sent,e.abrupt("return",h);case 20:case"end":return e.stop()}var b}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"isAlreadyAdded",get:function(){return this.bookExists}}]),e}();function N(e,t){document.dispatchEvent(new CustomEvent(e,{detail:t}))}function C(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return{do:function(e){t.forEach((function(t){return document.addEventListener(t,e)}))}}}function q(){var e=o.a.createRef();return o.a.createElement("div",null,o.a.createElement(p.b,{floating:!0,primary:!0,style:{height:32,width:32,padding:6},onClick:function(){return e.current.click()}},"add"),o.a.createElement("input",{type:"file",id:"file-selector",onChange:function(e){var t=e.target.files[0],n=new FileReader;n.addEventListener("load",function(){var e=Object(y.a)(v.a.mark((function e(t){var n,a,r;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=t.target.result,a=new A(n),e.next=5,a.parseDescription();case 5:if(r=e.sent,!a.isAlreadyAdded){e.next=9;break}return N("book-already-added",{book:r}),e.abrupt("return");case 9:return N("book-adding",{book:r}),e.next=12,a.parseBody();case 12:N("book-added",{book:r}),e.next=18;break;case 15:e.prev=15,e.t0=e.catch(0),console.error("error when parsing",e.t0);case 18:case"end":return e.stop()}}),e,null,[[0,15]])})));return function(t){return e.apply(this,arguments)}}()),n.readAsText(t)},ref:e}))}n(107);function D(e){var t=Object(r.useState)([]),n=Object(k.a)(t,2),a=n[0],c=n[1],i=Object(r.useState)(null),s=Object(k.a)(i,2),l=s[0],u=s[1];C("book-adding").do((function(e){u(e.detail.book)})),C("book-added").do(function(){var e=Object(y.a)(v.a.mark((function e(t){return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return u(null),e.t0=c,e.next=4,S();case 4:e.t1=e.sent,(0,e.t0)(e.t1);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),Object(r.useEffect)((function(){Object(y.a)(v.a.mark((function e(){return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=c,e.next=3,S();case 3:return e.t1=e.sent,e.abrupt("return",(0,e.t0)(e.t1));case 5:case"end":return e.stop()}}),e)})))()}),[]);return o.a.createElement("div",null,o.a.createElement(q,null),o.a.createElement("br",null),o.a.createElement("div",{id:"list"},l&&o.a.createElement(p.c,{key:l.title,className:"loading"},o.a.createElement(p.f,{title:l.title,subtitle:l.author,avatar:o.a.createElement(p.a,{src:l.image,role:"presentation"})}),o.a.createElement(p.d,{expander:!0},o.a.createElement(p.b,{flat:!0},o.a.createElement("div",{className:"lds-dual-ring"})),o.a.createElement(p.b,{flat:!0},"Loading...")),o.a.createElement(p.e,{expandable:!0,expanded:!0},l.annotation)),a.map((function(t){return o.a.createElement(p.c,{key:t.title},o.a.createElement(p.f,{title:t.title,subtitle:t.author,avatar:o.a.createElement(p.a,{src:t.image,role:"presentation"})}),o.a.createElement(p.d,{expander:!0},o.a.createElement(p.b,{flat:!0,onClick:function(){return function(t){return e.history.push("/read/".concat(t.hashHex))}(t)}},"Read"),o.a.createElement(p.b,{flat:!0},"Delete")),o.a.createElement(p.e,{expandable:!0},t.annotation))}))))}var P=n(51),R=n(8),M=n(11);function B(e){return H.apply(this,arguments)}function H(){return(H=Object(y.a)(v.a.mark((function e(t){var n,a,c,i,s,l,u,d,f;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.match.params.hash,a=Object(r.useState)(null),c=Object(k.a)(a,2),i=c[0],s=c[1],l=Object(r.useState)(null),u=Object(k.a)(l,2),d=u[0],f=u[1],Object(r.useEffect)((function(){function e(){return(e=Object(y.a)(v.a.mark((function e(){var t;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=3,j(n);case 3:return t=e.sent,s(t),e.t0=f,e.next=8,I(n);case 8:e.t1=e.sent,(0,e.t0)(e.t1);case 10:case"end":return e.stop()}}),e)})))).apply(this,arguments)}!function(){e.apply(this,arguments)}()}),[n]),e.abrupt("return",o.a.createElement("div",null,i&&o.a.createElement("div",null,o.a.createElement("h2",null,i.title),o.a.createElement("div",null,o.a.createElement("div",null,o.a.createElement("img",{src:i.image,align:"left",alt:i.title}),i.annotation),o.a.createElement("br",null),o.a.createElement("h3",null,d.title)))));case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var F=Object(M.a)(),L=function(e){Object(f.a)(n,e);var t=Object(m.a)(n);function n(){var e;return Object(u.a)(this,n),(e=t.call(this)).addToast=function(t,n){var a=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];e.setState((function(e){var r=e.toasts.slice();return r.push({text:t,action:n}),{toasts:r,autohide:a}}))},e.dismissToast=function(){var t=Object(l.a)(e.state.toasts).slice(1);e.setState({toasts:t})},e.setPage=function(t,n){e.navItems=e.navItems.map((function(e){return e.divider?e:Object(s.a)(Object(s.a)({},e),{},{active:e.key===t})})),e.setState({key:t,page:n})},e.hide=function(){e.setState({visible:!1,renderNode:null})},e.handleShow=function(){e.setState({renderNode:document.getElementById("navigation-drawer-demo")})},e.navItems=h.map((function(t){return t.divider?t:Object(s.a)(Object(s.a)({},t),{},{onClick:function(){return e.setPage(t.key,t.primaryText)}})})),e.state={toasts:[],renderNode:null,visible:!0,key:h[0].key,page:h[0].primaryText},C("book-already-added").do((function(t){var n=t.detail.book;e.addToast('Book "'.concat(n.title.toUpperCase(),'" has been added earlier!'))})),e}return Object(d.a)(n,[{key:"render",value:function(){var e=this.state,t=e.visible,n=e.renderNode,a=e.toasts;return o.a.createElement(P.a,{history:F,basename:"/fb2-reader"},o.a.createElement("div",null,o.a.createElement(p.g,{id:"navigation-drawer-demo","aria-label":"Navigation Drawer Demo",visible:t,fullPage:!0,focusOnMount:!1,onShow:this.handleShow,onHide:this.hide},o.a.createElement(p.i,{renderNode:n,navItems:this.navItems,mobileDrawerType:p.i.DrawerTypes.TEMPORARY_MINI,tabletDrawerType:p.i.DrawerTypes.PERSISTENT_MINI,desktopDrawerType:p.i.DrawerTypes.PERSISTENT_MINI,toolbarTitle:"FB2 Reader",toolbarActions:o.a.createElement(p.b,{icon:!0,onClick:this.hide},"close"),contentId:"main-demo-content",temporaryIcon:o.a.createElement(p.h,null,"menu"),persistentIcon:o.a.createElement(p.h,null,"arrow_back"),contentClassName:"md-grid"},o.a.createElement(R.d,null,o.a.createElement(R.b,{path:"/books",component:D}),o.a.createElement(R.b,{path:"/read/:hash",component:B}),o.a.createElement(R.a,{from:"/",to:"/books"}))),o.a.createElement(p.j,{id:"example-snackbar",toasts:a,autohide:!0,onDismiss:this.dismissToast,autohideTimeout:4e3}))))}}]),n}(r.PureComponent);Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));var _=n(53);n.n(_).a.load({google:{families:["Roboto:300,400,500,700","Material Icons"]}}),i.a.render(o.a.createElement(L,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))},58:function(e,t,n){e.exports=n(110)},63:function(e,t,n){},64:function(e,t,n){}},[[58,1,2]]]);
//# sourceMappingURL=main.d2ba5b1d.chunk.js.map