(this["webpackJsonpfb2-reader-react"]=this["webpackJsonpfb2-reader-react"]||[]).push([[0],{107:function(e,t,n){},110:function(e,t,n){"use strict";n.r(t);var a,r=n(1),o=n.n(r),i=n(4),c=n.n(i),l=(n(63),n(17)),s=n(55),u=n(27),d=n(28),m=n(56),f=n(54),h=(n(64),n(6)),p=[{key:"books",primaryText:"Books",leftIcon:o.a.createElement(h.h,null,"book"),active:!0},{key:"read",primaryText:"Read",leftIcon:o.a.createElement(h.h,null,"assignment")},{key:"drafts",primaryText:"Drafts",leftIcon:o.a.createElement(h.h,null,"drafts")},{key:"trash",primaryText:"Trash",leftIcon:o.a.createElement(h.h,null,"delete")}],b=n(9),v=n.n(b),k=n(15),y=n(20),x=n(57),E=Object(x.a)("fb2-reader",1,{upgrade:function(e){e.createObjectStore("books",{keyPath:"hashHex",autoIncrement:!0}).createIndex("author","author"),e.createObjectStore("sections",{keyPath:"id",autoIncrement:!0}).createIndex("parent","parent"),e.createObjectStore("elements",{keyPath:["sectionId","ordinal"]}).createIndex("sectionId","sectionId")}});function g(e){return a.count("books",e.hashHex)}function w(e){return a.add("sections",e)}function S(e){return a.add("elements",e)}function O(){return a?a.getAll("books"):E.then((function(){return a.getAll("books")}))}E.then((function(e){return a=e}));var j=n(37);var I=function(){function e(t){Object(u.a)(this,e),this.xml=t,this.ordinal=0}return Object(d.a)(e,[{key:"parseSection",value:function(){var e=Object(k.a)(v.a.mark((function e(t,n){var a,r,o,i,c,l,s,u,d;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=t.querySelector("title"),i=t.querySelector("image"),c=t.querySelectorAll(":scope > *"),e.next=5,w({parent:n,ordinal:this.ordinal++,title:null!==(a=null===o||void 0===o?void 0:o.textContent)&&void 0!==a?a:null,image:null!==(r=null===i||void 0===i?void 0:i.href)&&void 0!==r?r:null});case 5:l=e.sent,s=Object(j.a)(c),e.prev=7,s.s();case 9:if((u=s.n()).done){e.next=20;break}if("section"!==(d=u.value).tagName){e.next=16;break}return e.next=14,this.parseSection(d,l);case 14:e.next=18;break;case 16:return e.next=18,S({tag:d.tagName,content:d.innerHTML,sectionId:l,ordinal:this.ordinal++});case 18:e.next=9;break;case 20:e.next=25;break;case 22:e.prev=22,e.t0=e.catch(7),s.e(e.t0);case 25:return e.prev=25,s.f(),e.finish(25);case 28:case"end":return e.stop()}}),e,this,[[7,22,25,28]])})));return function(t,n){return e.apply(this,arguments)}}()},{key:"parseBody",value:function(){var e=Object(k.a)(v.a.mark((function e(){var t,n,r,o,i,c,l,s,u,d,m;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,f=this.book,a.add("books",f);case 2:return r=e.sent,o=this.body,i=o.querySelector("title"),c=o.querySelector("image"),l=o.querySelectorAll(":scope > section"),e.next=9,w({title:null!==(t=null===i||void 0===i?void 0:i.textContent)&&void 0!==t?t:null,image:null!==(n=null===c||void 0===c?void 0:c.href)&&void 0!==n?n:null,ordinal:this.ordinal++,parent:r});case 9:s=e.sent,u=Object(j.a)(l),e.prev=11,u.s();case 13:if((d=u.n()).done){e.next=19;break}return m=d.value,e.next=17,this.parseSection(m,s);case 17:e.next=13;break;case 19:e.next=24;break;case 21:e.prev=21,e.t0=e.catch(11),u.e(e.t0);case 24:return e.prev=24,u.f(),e.finish(24);case 27:case"end":return e.stop()}var f}),e,this,[[11,21,24,27]])})));return function(){return e.apply(this,arguments)}}()},{key:"parseDescription",value:function(){var e=Object(k.a)(v.a.mark((function e(){var t,n,a,r,o,i,c,l,s,u,d,m,f,h,p;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,window.crypto.subtle.digest("SHA-512",new TextEncoder("utf-8").encode(this.xml));case 2:return t=e.sent,b=t,n=Array.prototype.map.call(new Uint8Array(b),(function(e){return("00"+e.toString(16)).slice(-2)})).join(""),a=new DOMParser,r=a.parseFromString(this.xml,"application/xml"),o=r.querySelector("description"),i=o.querySelector("author first-name").textContent+" "+o.querySelector("author last-name").textContent,c=o.querySelector("book-title"),l=(l=o.querySelector("annotation"))&&l.textContent,(u=o.querySelector("coverpage image"))&&(d=u.getAttribute("l:href"))&&/^#/.test(d)&&(m=d.slice(1),(f=r.querySelector('binary[id="'.concat(m,'"]')))&&(h=f.getAttribute("content-type"),s="data:".concat(h,";base64,").concat(f.innerHTML))),p={hashHex:n,author:i,title:c.textContent,annotation:l,image:s},this.body=r.querySelector("body"),this.book=p,e.next=18,g(p);case 18:return this.bookExists=e.sent,e.abrupt("return",p);case 20:case"end":return e.stop()}var b}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"isAlreadyAdded",get:function(){return this.bookExists}}]),e}();function T(e,t){document.dispatchEvent(new CustomEvent(e,{detail:t}))}function A(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return{do:function(e){t.forEach((function(t){return document.addEventListener(t,e)}))}}}function N(){var e=o.a.createRef();return o.a.createElement("div",null,o.a.createElement(h.b,{floating:!0,primary:!0,style:{height:32,width:32,padding:6},onClick:function(){return e.current.click()}},"add"),o.a.createElement("input",{type:"file",id:"file-selector",onChange:function(e){var t=e.target.files[0],n=new FileReader;n.addEventListener("load",function(){var e=Object(k.a)(v.a.mark((function e(t){var n,a,r;return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=t.target.result,a=new I(n),e.next=5,a.parseDescription();case 5:if(r=e.sent,!a.isAlreadyAdded){e.next=9;break}return T("book-already-added",{book:r}),e.abrupt("return");case 9:return T("book-adding",{book:r}),e.next=12,a.parseBody();case 12:T("book-added",{book:r}),e.next=18;break;case 15:e.prev=15,e.t0=e.catch(0),console.error("error when parsing",e.t0);case 18:case"end":return e.stop()}}),e,null,[[0,15]])})));return function(t){return e.apply(this,arguments)}}()),n.readAsText(t)},ref:e}))}n(107);function C(e){var t=Object(r.useState)([]),n=Object(y.a)(t,2),a=n[0],i=n[1],c=Object(r.useState)(null),l=Object(y.a)(c,2),s=l[0],u=l[1];A("book-adding").do((function(e){u(e.detail.book)})),A("book-added").do(function(){var e=Object(k.a)(v.a.mark((function e(t){return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return u(null),e.t0=i,e.next=4,O();case 4:e.t1=e.sent,(0,e.t0)(e.t1);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),Object(r.useEffect)((function(){Object(k.a)(v.a.mark((function e(){return v.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=i,e.next=3,O();case 3:return e.t1=e.sent,e.abrupt("return",(0,e.t0)(e.t1));case 5:case"end":return e.stop()}}),e)})))()}),[]);return o.a.createElement("div",null,o.a.createElement(N,null),o.a.createElement("br",null),o.a.createElement("div",{id:"list"},s&&o.a.createElement(h.c,{key:s.title,className:"loading"},o.a.createElement(h.f,{title:s.title,subtitle:s.author,avatar:o.a.createElement(h.a,{src:s.image,role:"presentation"})}),o.a.createElement(h.d,{expander:!0},o.a.createElement(h.b,{flat:!0},o.a.createElement("div",{className:"lds-dual-ring"})),o.a.createElement(h.b,{flat:!0},"Loading...")),o.a.createElement(h.e,{expandable:!0,expanded:!0},s.annotation)),a.map((function(t){return o.a.createElement(h.c,{key:t.title},o.a.createElement(h.f,{title:t.title,subtitle:t.author,avatar:o.a.createElement(h.a,{src:t.image,role:"presentation"})}),o.a.createElement(h.d,{expander:!0},o.a.createElement(h.b,{flat:!0,onClick:function(){return function(t){return e.history.push("/read/".concat(t.hashHex))}(t)}},"Read"),o.a.createElement(h.b,{flat:!0},"Delete")),o.a.createElement(h.e,{expandable:!0},t.annotation))}))))}var q=n(51),D=n(7),P=n(10);function R(e){var t=e.match.params.hash,n=Object(r.useState)(null),i=Object(y.a)(n,2),c=i[0],l=i[1],s=Object(r.useState)(null),u=Object(y.a)(s,2),d=u[0],m=u[1];return Object(r.useEffect)((function(){(function(e){return a?a.get("books",e):E.then((function(){return a.get("books",e)}))})(t).then(l),function(e){return a?a.getFromIndex("sections","parent",e):E.then((function(){return a.getFromIndex("sections","parent",e)}))}(t).then(m)}),[t]),c?o.a.createElement("div",null,o.a.createElement("div",null,o.a.createElement("h2",null,c.title),o.a.createElement("div",null,o.a.createElement("div",null,o.a.createElement("img",{src:c.image,align:"left",alt:c.title}),c.annotation),o.a.createElement("br",null),o.a.createElement("h3",null,d.title)))):o.a.createElement("div",null,"loading...")}var M=Object(P.a)(),B=function(e){Object(m.a)(n,e);var t=Object(f.a)(n);function n(){var e;return Object(u.a)(this,n),(e=t.call(this)).addToast=function(t,n){var a=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];e.setState((function(e){var r=e.toasts.slice();return r.push({text:t,action:n}),{toasts:r,autohide:a}}))},e.dismissToast=function(){var t=Object(s.a)(e.state.toasts).slice(1);e.setState({toasts:t})},e.setPage=function(t,n){e.navItems=e.navItems.map((function(e){return e.divider?e:Object(l.a)(Object(l.a)({},e),{},{active:e.key===t})})),e.setState({key:t,page:n})},e.hide=function(){e.setState({visible:!1,renderNode:null})},e.handleShow=function(){e.setState({renderNode:document.getElementById("navigation-drawer-demo")})},e.navItems=p.map((function(t){return t.divider?t:Object(l.a)(Object(l.a)({},t),{},{onClick:function(){return e.setPage(t.key,t.primaryText)}})})),e.state={toasts:[],renderNode:null,visible:!0,key:p[0].key,page:p[0].primaryText},A("book-already-added").do((function(t){var n=t.detail.book;e.addToast('Book "'.concat(n.title.toUpperCase(),'" has been added earlier!'))})),e}return Object(d.a)(n,[{key:"render",value:function(){var e=this.state,t=e.visible,n=e.renderNode,a=e.toasts;return o.a.createElement(q.a,{history:M,basename:"/fb2-reader"},o.a.createElement("div",null,o.a.createElement(h.g,{id:"navigation-drawer-demo","aria-label":"Navigation Drawer Demo",visible:t,fullPage:!0,focusOnMount:!1,onShow:this.handleShow,onHide:this.hide},o.a.createElement(h.i,{renderNode:n,navItems:this.navItems,mobileDrawerType:h.i.DrawerTypes.TEMPORARY_MINI,tabletDrawerType:h.i.DrawerTypes.PERSISTENT_MINI,desktopDrawerType:h.i.DrawerTypes.PERSISTENT_MINI,toolbarTitle:"FB2 Reader",toolbarActions:o.a.createElement(h.b,{icon:!0,onClick:this.hide},"close"),contentId:"main-demo-content",temporaryIcon:o.a.createElement(h.h,null,"menu"),persistentIcon:o.a.createElement(h.h,null,"arrow_back"),contentClassName:"md-grid"},o.a.createElement(D.d,null,o.a.createElement(D.b,{path:"/books",component:C}),o.a.createElement(D.b,{path:"/read/:hash",component:R}),o.a.createElement(D.a,{from:"/",to:"/books"}))),o.a.createElement(h.j,{id:"example-snackbar",toasts:a,autohide:!0,onDismiss:this.dismissToast,autohideTimeout:4e3}))))}}]),n}(r.PureComponent);Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));var H=n(53);n.n(H).a.load({google:{families:["Roboto:300,400,500,700","Material Icons"]}}),c.a.render(o.a.createElement(B,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then((function(e){e.unregister()})).catch((function(e){console.error(e.message)}))},58:function(e,t,n){e.exports=n(110)},63:function(e,t,n){},64:function(e,t,n){}},[[58,1,2]]]);
//# sourceMappingURL=main.b64b60e9.chunk.js.map